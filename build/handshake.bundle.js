!function(e){if("object"==typeof exports&&"undefined"!=typeof module)module.exports=e();else if("function"==typeof define&&define.amd)define([],e);else{var f;"undefined"!=typeof window?f=window:"undefined"!=typeof global?f=global:"undefined"!=typeof self&&(f=self),f.Handshake=e()}}(function(){var define,module,exports;return function e(t,n,r){function s(o,u){if(!n[o]){if(!t[o]){var a=typeof require=="function"&&require;if(!u&&a)return a(o,!0);if(i)return i(o,!0);var f=new Error("Cannot find module '"+o+"'");throw f.code="MODULE_NOT_FOUND",f}var l=n[o]={exports:{}};t[o][0].call(l.exports,function(e){var n=t[o][1][e];return s(n?n:e)},l,l.exports,e,t,n,r)}return n[o].exports}var i=typeof require=="function"&&require;for(var o=0;o<r.length;o++)s(r[o]);return s}({1:[function(require,module,exports){var Utils=require("yutils");exports.LocalAddress=Utils.guid()},{yutils:7}],2:[function(require,module,exports){exports.MESSAGE=0;exports.TELL_ADDRESS=1;exports.OFFER=3;exports.ANSWER=4;exports.ERROR_CANNOT_FIND_PEER=5},{}],3:[function(require,module,exports){var WebRTC=require("webrtc-adapter");var RTCPeerConnection=WebRTC.RTCPeerConnection;var MESSAGE_TYPE=require("./MESSAGE_TYPE.js");var ADDRESS=require("./Address").LocalAddress;var PeerCache=require("./PeerCache").PeerCache;var Handshake=require("./handshake.js");var ICE_CONFIG={iceServers:[{url:"stun:23.21.150.121"},{url:"turn:192.158.29.39:3478?transport=udp",credential:"JZEOEt2V3Qb0y27GRntt2u2PAYA=",username:"28224511:1379330808"}]};var CONN={optional:[{DtlsSrtpKeyAgreement:true}]};function Peer(){var pc=new RTCPeerConnection(ICE_CONFIG,CONN);this.pc=pc;this.address=null;this.dc=null;this.onOpen=[];this.onMessage=[];this.onDisconnect=[];this.offerCallback=null;this.createCallback=null;this.iceTimeout=null;var self=this;this.disconnectCounter=0;this.thread=setInterval(function(){var i=0,L=self.onDisconnect.length;if(self.dc!==null){if(self.dc.readyState==="closed"){if(self.disconnectCounter>5){for(;i<L;i++){self.onDisconnect[i].call(self)}clearInterval(self.thread)}else{self.disconnectCounter+=1}}else{self.disconnectCounter=0}}},100);function exec(){clearTimeout(self.iceTimeout);var d=JSON.stringify(pc.localDescription);if(self.offerCallback!==null){self.offerCallback.call(self,d);self.offerCallback=null}else if(self.createCallback!==null){self.createCallback.call(self,d);self.createCallback=null}pc.onicecandidate=null}pc.onicecandidate=function(e){if(e.candidate===null){exec()}else{if(self.iceTimeout!==null){clearTimeout(self.iceTimeout)}self.iceTimeout=setTimeout(function(){exec()},1e3)}}}Peer.prototype.isOpen=function(){if(this.dc!==null){return this.dc.readyState==="open"}return false};Peer.prototype.disconnect=function(){this.dc.close()};Peer.prototype.ondisconnect=function(callback){this.onDisconnect.push(callback)};Peer.prototype.onopen=function(callback){this.onOpen.push(callback)};Peer.prototype.onmessage=function(callback){this.onMessage.push(callback)};Peer.prototype.send=function(message){if(this.dc===null||this.dc.readyState!=="open"){throw new Error("Handshake incomplete! Sending is not possible.")}this.dc.send(JSON.stringify({type:MESSAGE_TYPE.MESSAGE,payload:message}))};Peer.prototype.sendMessageType=function(messageType,payload){if(this.dc===null||this.dc.readyState!=="open"){throw new Error("Handshake incomplete! Sending is not possible.")}if(typeof payload==="undefined"){this.dc.send(JSON.stringify({type:messageType}))}else{this.dc.send(JSON.stringify({type:messageType,payload:payload}))}};Peer.prototype.attemptToConnect=function(address){var self=this;var other=Handshake.createOffer(function(offer){self.sendMessageType(MESSAGE_TYPE.OFFER,{offer:offer,target:address,source:ADDRESS})});PeerCache.putPending(other,address);return other};exports.Peer=Peer},{"./Address":1,"./MESSAGE_TYPE.js":2,"./PeerCache":4,"./handshake.js":5,"webrtc-adapter":6}],4:[function(require,module,exports){var cache={};var pending={};exports.PeerCache={put:function(peer){if(!peer.isOpen())throw new Error("Cannot put not-opened peers into cache!");if(peer.address in cache)throw new Error("Connection is already open! Cannot put into cache.");cache[peer.address]=peer;peer.ondisconnect(function(){delete cache[peer.address]});console.log("PeerCache",cache)},has:function(address){return address in cache},get:function(address){return cache[address]},putPending:function(peer,address){if(peer.isOpen())throw new Error("Cannot at peer to pending because it is already open!");if(address in pending)throw new Error("Connection is already pending! Cannot put into cache.");peer.onopen(function(){delete pending[address]});pending[address]=peer},getPending:function(address){return pending[address]}}},{}],5:[function(require,module,exports){var Utils=require("yutils");var Peer=require("./Peer.js").Peer;var PeerCache=require("./PeerCache.js").PeerCache;var MESSAGE_TYPE=require("./MESSAGE_TYPE.js");var ADDRESS=require("./Address").LocalAddress;var onRemoteConnectionCallbacks=[];function createOffer(callback){var peer=new Peer,pc=peer.pc;peer.offerCallback=callback;var dc=pc.createDataChannel("q",{reliable:true});pc.createOffer(function(desc){pc.setLocalDescription(desc,function(){})},function failure(e){console.error(e)});dc.onopen=function(){dc.send(JSON.stringify({type:MESSAGE_TYPE.TELL_ADDRESS,payload:ADDRESS}))};dc.onmessage=handleMessage(peer);peer.dc=dc;return peer}function handleMessage(peer){return function(e){var msg=Utils.isString(e.data)?JSON.parse(e.data):e.data;var i,L,newPeer,destinationPeer;switch(msg.type){case MESSAGE_TYPE.OFFER:if("target"in msg.payload){if(PeerCache.has(msg.payload.target)){destinationPeer=PeerCache.get(msg.payload.target);destinationPeer.sendMessageType(MESSAGE_TYPE.OFFER,{offer:msg.payload.offer,source:msg.payload.source})}else{peer.sendMessageType(MESSAGE_TYPE.ERROR_CANNOT_FIND_PEER,msg.payload.target)}}else{newPeer=createAnswer(msg.payload.offer,function(answer){peer.sendMessageType(MESSAGE_TYPE.ANSWER,{answer:answer,source:msg.payload.source,target:ADDRESS})});i=0,L=onRemoteConnectionCallbacks.length;for(;i<L;i++){onRemoteConnectionCallbacks[i].call(newPeer,newPeer)}}break;case MESSAGE_TYPE.ANSWER:if("source"in msg.payload){if(PeerCache.has(msg.payload.source)){destinationPeer=PeerCache.get(msg.payload.source);destinationPeer.sendMessageType(MESSAGE_TYPE.ANSWER,{answer:msg.payload.answer,target:msg.payload.target})}else{peer.sendMessageType(MESSAGE_TYPE.ERROR_CANNOT_FIND_PEER,msg.payload.target)}}else{destinationPeer=PeerCache.getPending(msg.payload.target);handleAnswer(destinationPeer,msg.payload.answer)}break;case MESSAGE_TYPE.TELL_ADDRESS:peer.address=msg.payload;i=0,L=peer.onOpen.length;PeerCache.put(peer);for(;i<L;i++){peer.onOpen[i].call(peer)}peer.onOpen=null;break;case MESSAGE_TYPE.MESSAGE:i=0,L=peer.onMessage.length;for(;i<L;i++){peer.onMessage[i].call(peer,msg.payload)}break}}}function createAnswer(offer,callback){var peer=new Peer,pc=peer.pc;var offerDesc=new RTCSessionDescription(JSON.parse(offer));peer.createCallback=callback;pc.setRemoteDescription(offerDesc);pc.createAnswer(function(answerDesc){pc.setLocalDescription(answerDesc)},function(){console.warn("No create answer")});pc.ondatachannel=function(e){var dc=e.channel||e;peer.dc=dc;dc.onopen=function(){dc.send(JSON.stringify({type:MESSAGE_TYPE.TELL_ADDRESS,payload:ADDRESS}))};dc.onmessage=handleMessage(peer)};return peer}function handleAnswer(peer,answer){var answerDesc=new RTCSessionDescription(JSON.parse(answer));peer.pc.setRemoteDescription(answerDesc)}function onRemoteConnection(callback){onRemoteConnectionCallbacks.push(callback)}exports.createOffer=createOffer;exports.handleAnswer=handleAnswer;exports.createAnswer=createAnswer;exports.onRemoteConnection=onRemoteConnection;exports.address=function(){return ADDRESS}},{"./Address":1,"./MESSAGE_TYPE.js":2,"./Peer.js":3,"./PeerCache.js":4,yutils:7}],6:[function(require,module,exports){"use strict";var myRTCPeerConnection=null;var myRTCSessionDescription=null;var myRTCIceCandidate=null;var renameIceURLs=function(config){if(!config){return}if(!config.iceServers){return config}config.iceServers.forEach(function(server){server.url=server.urls;delete server.urls});return config};var fixChromeStatsResponse=function(response){var standardReport={};var reports=response.result();reports.forEach(function(report){var standardStats={id:report.id,timestamp:report.timestamp,type:report.type};report.names().forEach(function(name){standardStats[name]=report.stat(name)});standardReport[standardStats.id]=standardStats});return standardReport};var sessionHasData=function(desc){if(!desc){return false}var hasData=false;var prefix="m=application";desc.sdp.split("\n").forEach(function(line){if(line.slice(0,prefix.length)===prefix){hasData=true}});return hasData};if(typeof RTCPeerConnection!=="undefined"){myRTCPeerConnection=RTCPeerConnection}else if(typeof mozRTCPeerConnection!=="undefined"){myRTCPeerConnection=function(configuration,constraints){var pc=new mozRTCPeerConnection(renameIceURLs(configuration),constraints);var dataEnabled=false;var boundCreateDataChannel=pc.createDataChannel.bind(pc);pc.createDataChannel=function(label,dataChannelDict){var dc=boundCreateDataChannel(label,dataChannelDict);if(!dataEnabled){dataEnabled=true;if(pc.onnegotiationneeded&&!sessionHasData(pc.localDescription)&&!sessionHasData(pc.remoteDescription)){var event=new Event("negotiationneeded");pc.onnegotiationneeded(event)}}return dc};return pc}}else if(typeof webkitRTCPeerConnection!=="undefined"){myRTCPeerConnection=function(configuration,constraints){var pc=new webkitRTCPeerConnection(configuration,constraints);var boundGetStats=pc.getStats.bind(pc);pc.getStats=function(selector,successCallback,failureCallback){var successCallbackWrapper=function(chromeStatsResponse){successCallback(fixChromeStatsResponse(chromeStatsResponse))};boundGetStats(successCallbackWrapper,failureCallback,selector)};return pc}}if(typeof RTCSessionDescription!=="undefined"){myRTCSessionDescription=RTCSessionDescription}else if(typeof mozRTCSessionDescription!=="undefined"){myRTCSessionDescription=mozRTCSessionDescription}if(typeof RTCIceCandidate!=="undefined"){myRTCIceCandidate=RTCIceCandidate}else if(typeof mozRTCIceCandidate!=="undefined"){myRTCIceCandidate=mozRTCIceCandidate}exports.RTCPeerConnection=myRTCPeerConnection;exports.RTCSessionDescription=myRTCSessionDescription;exports.RTCIceCandidate=myRTCIceCandidate},{}],7:[function(require,module,exports){(function(exports){var perf=null;if(typeof performance==="undefined"){perf={}}else{perf=performance}perf.now=perf.now||perf.mozNow||perf.msNow||perf.oNow||perf.webkitNow||Date.now||function(){return(new Date).getTime()};function swap(array,i,j){if(i!==j){var temp=array[i];array[i]=array[j];array[j]=temp}}var getRandomInt=exports.getRandomInt=function(min,max){if(min>max)throw new Error("min must be smaller than max! {"+min+">"+max+"}");return Math.floor(Math.random()*(max-min+1))+min};exports.sample=function(list,n){var result=[],j,i=0,L=n>list.length?list.length:n,s=list.length-1;for(;i<L;i++){j=getRandomInt(i,s);swap(list,i,j);result.push(list[i])}return result};exports.isString=function(myVar){return typeof myVar==="string"||myVar instanceof String};exports.assertLength=function(arg,nbr){if(arg.length===nbr)return true;else throw new Error("Wrong number of arguments: expected:"+nbr+", but got: "+arg.length)};exports.guid=function(){var d=perf.now();var guid="xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(c){var r=(d+Math.random()*16)%16|0;d=Math.floor(d/16);return(c==="x"?r:r&3|8).toString(16)});return guid}})(typeof exports==="undefined"?this["yUtils"]={}:exports)},{}]},{},[5])(5)});